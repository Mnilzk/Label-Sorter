<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Pyodide, CSV-only)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    #progressBar { width: 70%; height: 18px; }
    #messages { color: #444; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Label Sorter (CSV only, runs in your browser!)</h1>
  <p>
    Upload your PDF of shipping labels and a CSV file with order codes.<br>
    The tool will reorder the PDF pages to match the order list, all on your device.<br>
    <b>Note:</b> No files are uploaded to any server.
  </p>
  <label>PDF file: <input type="file" id="pdfInput" accept=".pdf"></label><br><br>
  <label>Order CSV: <input type="file" id="orderInput" accept=".csv"></label><br><br>
  <button id="runBtn">Sort Labels</button>
  <br>
  <progress id="progressBar" value="0" max="100" style="display:none"></progress>
  <div id="messages">Loading Python...</div>
  <a id="downloadLink" style="display:none; margin-top:10px;">Download Sorted PDF</a>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script>
    let pyodide = null, pyReady = false, mainPyCode = "";

    async function loadPy() {
      document.getElementById("messages").textContent = "Loading Python runtime (Pyodide)...";
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
      document.getElementById("messages").textContent = "Loaded Python. Installing pandas...";
      await pyodide.loadPackage("pandas");
      document.getElementById("messages").textContent = "Loaded Python. Downloading logic...";
      // Fetch main.py from the same folder as index.html
      mainPyCode = await fetch("main.py").then(r => r.text());
      pyReady = true;
      document.getElementById("messages").textContent = "Ready! Upload files and click Sort Labels.";
    }
    loadPy();

    document.getElementById("runBtn").onclick = async () => {
      if (!pyReady) { document.getElementById("messages").textContent = "Please wait for Python to load..."; return; }
      let pdfFile = document.getElementById('pdfInput').files[0];
      let csvFile = document.getElementById('orderInput').files[0];
      if (!pdfFile || !csvFile) { document.getElementById("messages").textContent = "Please select both files."; return; }
      document.getElementById("progressBar").style.display = ""; document.getElementById("progressBar").value = 5;
      document.getElementById("messages").textContent = "Reading files...";
      // Read files as Uint8Array
      let pdfBuf = new Uint8Array(await pdfFile.arrayBuffer());
      let csvStr = await csvFile.text();
      // Provide browser-side progress function
      pyodide.globals.set("setProgress", pct => document.getElementById("progressBar").value = pct);
      pyodide.globals.set("setMessage", msg => document.getElementById("messages").textContent = msg);
      pyodide.globals.set("pdf_bytes", pdfBuf);
      pyodide.globals.set("csv_text", csvStr);
      document.getElementById("messages").textContent = "Running label sort...";
      try {
        await pyodide.runPythonAsync(mainPyCode + `
result_bytes = sort_labels_browser(pdf_bytes, csv_text, setProgress, setMessage)
        `);
        let resultBytes = pyodide.globals.get('result_bytes').toJs();
        let blob = new Blob([resultBytes], {type: "application/pdf"});
        let url = URL.createObjectURL(blob);
        let link = document.getElementById("downloadLink");
        link.href = url; link.style.display = ""; link.textContent = "Download Sorted PDF";
        document.getElementById("messages").textContent = "Done! Download your sorted PDF.";
      } catch (e) {
        document.getElementById("messages").textContent = "Python error: " + e;
      }
      document.getElementById("progressBar").style.display = "none";
    }
  </script>
</body>
</html>
