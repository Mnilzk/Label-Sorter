<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Barcode, Browser-only)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 32px; }
    h1 { color: #1a80e6; }
    #progressBar { width: 95%; height: 14px; margin: 14px 0; }
  </style>
  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
  <!-- QuaggaJS for barcode detection -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
</head>
<body>
  <h1>Label Sorter (Barcode, Browser-only2)</h1>
  <p>
    Upload your <b>PDF</b> of shipping labels and a <b>CSV</b> order file.<br>
    The tool will extract barcodes from each page and reorder pages to match your CSV order, all in your browser.
  </p>
  <label>PDF file: <input type="file" id="pdfInput" accept=".pdf"></label><br><br>
  <label>Order CSV: <input type="file" id="csvInput" accept=".csv"></label><br><br>
  <button id="processBtn">Process</button><br>
  <progress id="progressBar" value="0" max="100" style="width:98%;display:none"></progress>
  <div id="status" style="margin:14px 0;color:#444"></div>
  <a id="downloadLink" style="display:none;margin-top:10px;">Download Reordered PDF</a>
  <script>
    // Helper: Read file as ArrayBuffer or text
    function readFileAsync(file, asText=false) {
      return new Promise((resolve, reject) => {
        let r = new FileReader();
        r.onload = e => resolve(e.target.result);
        r.onerror = reject;
        if (asText) r.readAsText(file);
        else r.readAsArrayBuffer(file);
      });
    }

    // Parse CSV order file to array of codes
    function parseCsvOrder(csvText) {
      return csvText.trim().split(/\r?\n/).map(row => row.split(',')[0].replace(/"/g,"").trim()).filter(x => x);
    }

    document.getElementById('processBtn').onclick = async () => {
      let pdfFile = document.getElementById('pdfInput').files[0];
      let csvFile = document.getElementById('csvInput').files[0];
      let statusDiv = document.getElementById('status');
      let progressBar = document.getElementById('progressBar');
      if (!pdfFile || !csvFile) { statusDiv.textContent = "Upload both PDF and CSV files!"; return; }
      statusDiv.textContent = "Loading PDF...";
      progressBar.style.display = "";
      progressBar.value = 0;

      // Read CSV
      let csvText = await readFileAsync(csvFile, true);
      let orderCodes = parseCsvOrder(csvText);

      // Load PDF
      let pdfBytes = new Uint8Array(await readFileAsync(pdfFile));
      let pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";
      let pdfDoc = await pdfjsLib.getDocument({data: pdfBytes}).promise;

      // Extract barcodes from each page
      let pageBarcodes = [];
      for (let i=0; i<pdfDoc.numPages; i++) {
        statusDiv.textContent = `Rendering page ${i+1} of ${pdfDoc.numPages}...`;
        progressBar.value = ((i+1)/pdfDoc.numPages)*100;
        let page = await pdfDoc.getPage(i+1);
        let viewport = page.getViewport({ scale: 2 });
        let canvas = document.createElement('canvas');
        canvas.width = viewport.width; canvas.height = viewport.height;
        let ctx = canvas.getContext('2d');
        await page.render({canvasContext: ctx, viewport}).promise;

        // Use QuaggaJS to detect barcode on the canvas
        let barcode = await new Promise(resolve => {
          Quagga.decodeSingle({
            src: canvas.toDataURL(),
            numOfWorkers: 0, // required for decodeSingle
            inputStream: { size: 800 },
            decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"] }
          }, result => resolve(result && result.codeResult ? result.codeResult.code : null));
        });
        pageBarcodes.push({page: i, barcode});
        await new Promise(r => setTimeout(r, 0)); // let UI update
      }

      // Match and reorder
      let barcodeToPage = Object.fromEntries(pageBarcodes.map(obj => [obj.barcode, obj.page]));
      let sortedPages = orderCodes.map(code => barcodeToPage[code]).filter(x => x!==undefined);

      if (!sortedPages.length) {
        statusDiv.textContent = "No barcodes matched between PDF and CSV!";
        return;
      }

      // Rebuild PDF using pdf-lib (for browser, best reliability)
      statusDiv.textContent = "Building new PDF...";
      const pdfLibSrc = "https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js";
      if (!window.PDFLib) await import(pdfLibSrc);
      const { PDFDocument } = window.PDFLib;
      let srcPdf = await PDFDocument.load(pdfBytes);
      let outPdf = await PDFDocument.create();
      for (let pg of sortedPages) {
        let [copied] = await outPdf.copyPages(srcPdf, [pg]);
        outPdf.addPage(copied);
      }
      let outBytes = await outPdf.save();

      // Show download
      let link = document.getElementById("downloadLink");
      link.href = URL.createObjectURL(new Blob([outBytes], {type:"application/pdf"}));
      link.style.display = "";
      link.textContent = "Download Reordered PDF";
      statusDiv.textContent = "Done! Download your PDF.";
      progressBar.style.display = "none";
    };
  </script>
  <!-- pdf-lib for PDF manipulation -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</body>
</html>
