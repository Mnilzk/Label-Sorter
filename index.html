<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Pyodide Version)</title>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
</head>
<body>
  <h2>Label Sorter (All in browser!)</h2>
  <p>Upload your PDF and CSV/XLSX. The Python code will run in your browser using Pyodide.</p>
  <label>PDF file: <input type="file" id="pdfInput" accept=".pdf"></label><br>
  <label>Order CSV/XLSX: <input type="file" id="orderInput" accept=".csv,.xlsx"></label><br>
  <button id="processBtn">Process</button>
  <div id="status"></div>
  <a id="downloadLink" style="display:none">Download Reordered PDF</a>

  <script type="text/javascript">
    let pyodideReadyPromise = loadPyodide({ indexURL : "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" });

    async function runPythonReorder(pdfBytes, csvBytes, csvName) {
      const pyodide = await pyodideReadyPromise;
      // Install packages if needed (e.g., pandas, pypdf)
      await pyodide.loadPackage(['micropip']);
      await pyodide.runPythonAsync(`
import micropip
await micropip.install(['pypdf', 'pandas'])
`);
      // Python code will run here
      // Pass the data from JS using js module
      pyodide.globals.set('pdf_bytes', pdfBytes);
      pyodide.globals.set('csv_bytes', csvBytes);
      pyodide.globals.set('csv_name', csvName);

      await pyodide.runPythonAsync(`
import pandas as pd
from pypdf import PdfReader, PdfWriter
import io

# CSV detection
ext = csv_name.split('.')[-1]
if ext == 'xlsx':
    df = pd.read_excel(io.BytesIO(csv_bytes))
else:
    df = pd.read_csv(io.BytesIO(csv_bytes))

codes = df.iloc[:, 0].astype(str).tolist()
pdf = PdfReader(io.BytesIO(pdf_bytes))
writer = PdfWriter()
code_to_page = {}
for i, page in enumerate(pdf.pages):
    text = page.extract_text() or ''
    for code in codes:
        if code in text:
            code_to_page[code] = i
for code in codes:
    idx = code_to_page.get(code)
    if idx is not None:
        writer.add_page(pdf.pages[idx])
buf = io.BytesIO()
writer.write(buf)
result_bytes = buf.getvalue()
      `);
      // Get result back to JS
      return pyodide.globals.get('result_bytes').toJs();
    }

    document.getElementById('processBtn').onclick = async () => {
      const status = document.getElementById('status');
      const pdfFile = document.getElementById('pdfInput').files[0];
      const csvFile = document.getElementById('orderInput').files[0];
      if (!pdfFile || !csvFile) {
        status.textContent = "Upload both PDF and CSV/XLSX!";
        return;
      }
      status.textContent = "Loading Pyodide & reading files...";
      // Read files as ArrayBuffers
      const pdfBytes = await pdfFile.arrayBuffer();
      const csvBytes = await csvFile.arrayBuffer();
      status.textContent = "Processing in Python (browser)...";
      try {
        const reordered = await runPythonReorder(pdfBytes, csvBytes, csvFile.name);
        const blob = new Blob([reordered], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);
        const dl = document.getElementById('downloadLink');
        dl.href = url;
        dl.download = "sorted_labels.pdf";
        dl.style.display = "";
        status.textContent = "Done! Download below.";
      } catch (e) {
        status.textContent = "Error: " + e;
      }
    };
  </script>
</body>
</html>
