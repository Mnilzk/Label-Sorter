<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Pure Python in Browser, CSV-only)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #1983e6; }
    #progressBar { width: 70%; height: 18px; margin-top: 10px; }
    #messages { color: #444; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Label Sorter (CSV only, runs in your browser)</h1>
  <p>
    Upload a PDF of shipping labels and a <b>CSV</b> order file.<br>
    Pages will be reordered to match your order list.<br>
    <b>No server. 100% local processing via <a href="https://pyodide.org/" target="_blank">Pyodide</a>.</b>
  </p>
  <label>PDF file: <input type="file" id="pdfInput" accept=".pdf"></label>
  <br><br>
  <label>Order CSV: <input type="file" id="csvInput" accept=".csv"></label>
  <br><br>
  <button id="runBtn">Sort Labels</button>
  <br>
  <progress id="progressBar" value="0" max="100" style="display:none"></progress>
  <div id="messages">Loading Python (Pyodide)...</div>
  <a id="downloadLink" style="display:none; margin-top:10px;">Download Sorted PDF</a>

  <!-- Pyodide CDN -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script>
    let pyodideReady = false;
    let pyodide = null;
    let mainPyCode = null;

    // Load Pyodide and main.py code
    async function initPyodide() {
      document.getElementById("messages").textContent = "Loading Python (Pyodide)...";
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
      document.getElementById("messages").textContent = "Loaded Python. Downloading logic...";
      // fetch main.py (should be in the same repo as index.html)
      mainPyCode = await fetch("main.py").then(resp => resp.text());
      await pyodide.loadPackage("PyPDF2");
      pyodideReady = true;
      document.getElementById("messages").textContent = "Ready! Upload your files and press Sort Labels.";
    }
    initPyodide();

    document.getElementById('runBtn').onclick = async () => {
      if (!pyodideReady) {
        document.getElementById("messages").textContent = "Please wait until Python loads...";
        return;
      }
      let pdfFile = document.getElementById('pdfInput').files[0];
      let csvFile = document.getElementById('csvInput').files[0];
      if (!pdfFile || !csvFile) {
        document.getElementById("messages").textContent = "Please select BOTH PDF and CSV files.";
        return;
      }
      document.getElementById("messages").textContent = "Reading files...";
      document.getElementById("progressBar").style.display = "";
      document.getElementById("progressBar").value = 0;
      document.getElementById("downloadLink").style.display = "none";

      // Helper to read file as Uint8Array
      const fileToUint8Array = file => new Promise(res => {
        let r = new FileReader(); r.onload = e => res(new Uint8Array(e.target.result)); r.readAsArrayBuffer(file);
      });
      const pdfBuf = await fileToUint8Array(pdfFile);
      const csvBuf = await fileToUint8Array(csvFile);

      // Expose progress/message
      window.setProgress = v => document.getElementById("progressBar").value = v;
      window.setMessage = msg => document.getElementById("messages").textContent = msg;

      pyodide.globals.set("pdf_data", pdfBuf);
      pyodide.globals.set("csv_data", csvBuf);

      try {
        await pyodide.runPythonAsync(mainPyCode + `
result_bytes = sort_labels_browser(pdf_data, csv_data, setProgress, setMessage)
        `);
        let resultBytes = pyodide.globals.get('result_bytes').toJs();
        let blob = new Blob([resultBytes], {type: "application/pdf"});
        let url = URL.createObjectURL(blob);
        let link = document.getElementById("downloadLink");
        link.href = url;
        link.style.display = "";
        link.textContent = "Download Sorted PDF";
        document.getElementById("messages").textContent = "Done! Download your sorted PDF.";
      } catch (err) {
        document.getElementById("messages").textContent = "Python error: " + err;
      }
      document.getElementById("progressBar").style.display = "none";
    }
  </script>
</body>
</html>
