<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Runs in your browser, no server!)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; }
    h1 { color: #1983e6; }
    #progressBar { width: 70%; height: 18px; margin-top: 10px; }
    #messages { color: #444; margin-top: 15px; }
  </style>
</head>
<body>
  <h1>Label Sorter (Runs in your browser, no server!)</h1>
  <p>
    Upload a PDF of shipping labels and a CSV/XLSX order file.<br>
    The pages will be reordered to match the order list on your device.<br>
    <b>Note:</b> This runs pure Python in your browser using <a href="https://pyodide.org/" target="_blank">Pyodide</a>.
  </p>
  <label>PDF file: <input type="file" id="pdfInput" accept=".pdf"></label>
  <br><br>
  <label>Order CSV/XLSX: <input type="file" id="orderInput" accept=".csv,.xlsx"></label>
  <br><br>
  <button id="runBtn">Sort Labels</button>
  <br>
  <progress id="progressBar" value="0" max="100" style="display:none"></progress>
  <div id="messages">Please wait, loading Python...</div>
  <a id="downloadLink" style="display:none; margin-top:10px;">Download Sorted PDF</a>

  <!-- Pyodide CDN -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
  <script>
    let pyodideReady = false;
    let pyodide = null;
    let mainPyCode = null;

    // Load Pyodide and Python code
    async function initPyodide() {
      document.getElementById("messages").textContent = "Please wait, loading Python runtime (Pyodide)...";
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
      document.getElementById("messages").textContent = "Python loaded. Loading main logic...";
      // Fetch main.py from your repo
      mainPyCode = await fetch("main.py").then(resp => resp.text());
      await pyodide.loadPackage(["micropip", "pandas", "openpyxl", "PyPDF2"]);
      document.getElementById("messages").textContent = "Ready! Upload files and press 'Sort Labels'.";
      pyodideReady = true;
    }

    initPyodide();

    // Handle the button click
    document.getElementById('runBtn').onclick = async () => {
      if (!pyodideReady) {
        document.getElementById("messages").textContent = "Python still loading, please wait...";
        return;
      }
      let pdfFile = document.getElementById('pdfInput').files[0];
      let orderFile = document.getElementById('orderInput').files[0];
      if (!pdfFile || !orderFile) {
        document.getElementById("messages").textContent = "Please select both files!";
        return;
      }
      // Read files as ArrayBuffer and send to Python
      const readAsArrayBuffer = file => new Promise(res => { let r = new FileReader(); r.onload = e => res(new Uint8Array(e.target.result)); r.readAsArrayBuffer(file); });
      const pdfBuf = await readAsArrayBuffer(pdfFile);
      const orderBuf = await readAsArrayBuffer(orderFile);

      // Expose progress update from Python
      window.setProgress = pct => {
        let bar = document.getElementById("progressBar");
        bar.style.display = "";
        bar.value = pct;
      }
      window.setMessage = msg => { document.getElementById("messages").textContent = msg; }

      // Register Python helpers
      pyodide.globals.set("pdf_data", pdfBuf);
      pyodide.globals.set("order_data", orderBuf);

      // Now run your main logic (see below for main.py)
      document.getElementById("messages").textContent = "Running Python, sorting labels...";
      document.getElementById("progressBar").style.display = "";
      document.getElementById("progressBar").value = 0;

      try {
        await pyodide.runPythonAsync(mainPyCode + `
result_bytes = sort_labels_browser(pdf_data, order_data, setProgress, setMessage)
        `);
        let resultBytes = pyodide.globals.get('result_bytes').toJs();
        let blob = new Blob([resultBytes], {type: "application/pdf"});
        let url = URL.createObjectURL(blob);
        let link = document.getElementById("downloadLink");
        link.href = url;
        link.style.display = "";
        link.textContent = "Download Sorted PDF";
        document.getElementById("messages").textContent = "Done! Download your sorted PDF.";
      } catch (err) {
        document.getElementById("messages").textContent = "Python error: " + err;
      }
      document.getElementById("progressBar").style.display = "none";
    }
  </script>
</body>
</html>
