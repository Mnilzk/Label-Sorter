<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Label Sorter (Pyodide In-Browser)</title>
</head>
<body>
  <h1>Label Sorter (Runs Pure Python in Browser)</h1>
  <input type="file" id="pdf" accept="application/pdf"><br>
  <input type="file" id="csv" accept=".csv, .xlsx"><br>
  <button id="run">Sort Labels</button>
  <div id="output"></div>
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <script>
    let pyodideReadyPromise = loadPyodide({indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/"});
    let pdfBytes = null, csvBytes = null;

    document.getElementById('pdf').onchange = e => {
      let f = e.target.files[0];
      let reader = new FileReader();
      reader.onload = ev => { pdfBytes = new Uint8Array(ev.target.result); };
      reader.readAsArrayBuffer(f);
    };

    document.getElementById('csv').onchange = e => {
      let f = e.target.files[0];
      let reader = new FileReader();
      reader.onload = ev => { csvBytes = new Uint8Array(ev.target.result); };
      reader.readAsArrayBuffer(f);
    };

    document.getElementById('run').onclick = async () => {
      const pyodide = await pyodideReadyPromise;
      await pyodide.loadPackage(["micropip"]);
      await pyodide.runPythonAsync(`
import micropip
await micropip.install("PyPDF2")
await micropip.install("pandas")
      `);

      // Pass the uploaded files to Pyodide
      pyodide.FS.writeFile("input.pdf", pdfBytes);
      pyodide.FS.writeFile("orders.csv", csvBytes);

      let pythonCode = `
import PyPDF2
import pandas as pd

# Load order codes
df = pd.read_csv("orders.csv")
codes = df.iloc[:,0].astype(str).tolist()

# Read the PDF
reader = PyPDF2.PdfReader(open("input.pdf", "rb"))
pages = list(reader.pages)

# For this demo, just copy all pages (replace with your sorting logic)
writer = PyPDF2.PdfWriter()
for p in pages:
    writer.add_page(p)

with open("output.pdf", "wb") as f:
    writer.write(f)
      `;
      await pyodide.runPythonAsync(pythonCode);

      // Download result
      let output = pyodide.FS.readFile("output.pdf");
      let blob = new Blob([output], {type: "application/pdf"});
      let a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "sorted_labels.pdf";
      a.textContent = "Download Sorted Labels";
      document.getElementById('output').innerHTML = '';
      document.getElementById('output').appendChild(a);
    };
  </script>
</body>
</html>
